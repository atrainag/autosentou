"""
Simple test for Vulnerability Analysis phase
Run with: python tests/test_vulnerability_analysis.py
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from database import SessionLocal
from models import Job
from services.phases.vulnerability_analysis import run_vulnerability_analysis_phase_enhanced


def test_vulnerability_analysis():
    """Test Vulnerability Analysis phase."""
    db = SessionLocal()

    try:
        # Create test job
        job = Job(
            id="test-vuln-analysis-001",
            target="scanme.nmap.org",
            description="Test Vulnerability Analysis",
            status="running",
        )
        db.add(job)
        db.commit()
        db.refresh(job)

        print(f"Created test job: {job.id}")
        print(f"Target: {job.target}\n")

        # Mock info gathering data
        info_data = {
            "open_ports": [22, 80, 443],
            "services": [
                {"port": 22, "service": "ssh", "version": "OpenSSH 7.4"},
                {"port": 80, "service": "http", "version": "Apache 2.4.6"},
            ],
            "os_detection": {"name": "Linux", "version": "3.x"}
        }

        # Mock web enumeration data
        web_enum_data = {
            "discovered_paths": [
                {"url": "http://scanme.nmap.org/admin", "risk_level": "high"}
            ]
        }

        # Run phase
        print("Starting Vulnerability Analysis Phase...")
        phase = run_vulnerability_analysis_phase_enhanced(db, job, info_data, web_enum_data)

        # Display results
        print("\n" + "=" * 60)
        print("VULNERABILITY ANALYSIS RESULTS")
        print("=" * 60)
        print(f"Status: {phase.status}")
        print(f"CVEs found: {len(phase.data.get('cve_vulnerabilities', []))}")
        print(f"Exploits found: {phase.data.get('total_exploits_found', 0)}")

        if phase.data.get('cve_vulnerabilities'):
            print("\nCVE Vulnerabilities:")
            for vuln in phase.data['cve_vulnerabilities'][:5]:
                print(f"  - {vuln.get('cve_id', 'N/A')}: {vuln.get('description', '')[:60]}...")

        print("\n✅ Test completed successfully!")

    except Exception as e:
        print(f"\n❌ Test failed: {e}")
        import traceback
        traceback.print_exc()

    finally:
        db.close()


if __name__ == "__main__":
    test_vulnerability_analysis()
