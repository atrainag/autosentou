"""
Google Exploit Searcher
Searches Google for exploit PoCs and vulnerability information
"""
import requests
import logging
import os
import re
from typing import List, Dict, Any, Optional
from urllib.parse import quote_plus

logger = logging.getLogger(__name__)


class GoogleSearcher:
    """Search Google for exploits and vulnerability information."""

    def __init__(self, api_key: Optional[str] = None, search_engine_id: Optional[str] = None):
        """
        Initialize Google searcher.

        Args:
            api_key: Google Custom Search API key (optional)
            search_engine_id: Google Custom Search Engine ID (optional)
        """
        self.api_key = api_key or os.getenv('GOOGLE_API_KEY')
        self.search_engine_id = search_engine_id or os.getenv('GOOGLE_SEARCH_ENGINE_ID')
        self.api_url = "https://www.googleapis.com/customsearch/v1"

        if self.api_key and self.search_engine_id:
            logger.info("Google searcher initialized with Custom Search API")
        else:
            logger.warning("Google Custom Search API not configured, using fallback method")

    def search_exploits(
        self,
        cve_id: Optional[str] = None,
        service: Optional[str] = None,
        version: Optional[str] = None,
        keywords: Optional[List[str]] = None,
        max_results: int = 10
    ) -> List[Dict[str, Any]]:
        """
        Search Google for exploits.

        Args:
            cve_id: CVE identifier
            service: Service name
            version: Version number
            keywords: Additional keywords
            max_results: Maximum results to return

        Returns:
            List of search results
        """
        try:
            # Build search query
            query_parts = []

            if cve_id:
                query_parts.append(cve_id)
            if service:
                query_parts.append(service)
            if version:
                query_parts.append(version)

            # Add exploit-specific keywords
            if keywords:
                query_parts.extend(keywords)
            else:
                query_parts.extend(['exploit', 'PoC', 'vulnerability'])

            query = ' '.join(query_parts)

            logger.info(f"Searching Google for: {query}")

            # Try API first
            if self.api_key and self.search_engine_id:
                results = self._search_with_api(query, max_results)
            else:
                # Fallback: return curated search URLs
                results = self._generate_search_links(query, max_results)

            return results

        except Exception as e:
            logger.error(f"Error searching Google: {e}", exc_info=True)
            return []

    def _search_with_api(self, query: str, max_results: int) -> List[Dict[str, Any]]:
        """Search using Google Custom Search API."""
        try:
            results = []
            num_pages = (max_results + 9) // 10  # 10 results per page

            for page in range(num_pages):
                start_index = page * 10 + 1

                params = {
                    'key': self.api_key,
                    'cx': self.search_engine_id,
                    'q': query,
                    'start': start_index,
                    'num': min(10, max_results - len(results))
                }

                response = requests.get(self.api_url, params=params, timeout=10)
                response.raise_for_status()

                data = response.json()

                for item in data.get('items', []):
                    result = self._parse_search_result(item)
                    results.append(result)

                if len(results) >= max_results:
                    break

            return results

        except requests.exceptions.RequestException as e:
            logger.error(f"Google API request failed: {e}")
            return []
        except Exception as e:
            logger.error(f"Error parsing Google API results: {e}")
            return []

    def _parse_search_result(self, item: Dict[str, Any]) -> Dict[str, Any]:
        """Parse Google search result."""
        try:
            title = item.get('title', '')
            url = item.get('link', '')
            snippet = item.get('snippet', '')

            # Extract CVEs from title and snippet
            cves = re.findall(r'CVE-\d{4}-\d+', title + ' ' + snippet, re.IGNORECASE)

            # Calculate relevance score
            score = 20  # Base score

            # Bonus for specific platforms
            if any(domain in url for domain in ['github.com', 'exploit-db.com', 'packetstormsecurity.com']):
                score += 30
            if 'github.com' in url:
                score += 10  # Extra for GitHub

            # Bonus for keywords in title
            title_lower = title.lower()
            if any(word in title_lower for word in ['exploit', 'poc', 'vulnerability', 'cve']):
                score += 20

            return {
                'source': 'google',
                'title': title,
                'url': url,
                'snippet': snippet,
                'cves': list(set(cves)),
                'score': score
            }

        except Exception as e:
            logger.error(f"Error parsing search result: {e}")
            return {
                'source': 'google',
                'error': str(e),
                'url': item.get('link', ''),
                'score': 0
            }

    def _generate_search_links(self, query: str, max_results: int) -> List[Dict[str, Any]]:
        """
        Generate search links for manual browsing (fallback when API not available).
        """
        encoded_query = quote_plus(query)

        search_links = [
            {
                'source': 'google',
                'title': f'Google Search: {query}',
                'url': f'https://www.google.com/search?q={encoded_query}',
                'snippet': 'Google search results (manual browsing required - API not configured)',
                'cves': [],
                'score': 10
            },
            {
                'source': 'google',
                'title': f'Google Search (site:github.com): {query}',
                'url': f'https://www.google.com/search?q=site:github.com+{encoded_query}',
                'snippet': 'GitHub-specific Google search (manual browsing required)',
                'cves': [],
                'score': 20
            },
            {
                'source': 'google',
                'title': f'Google Search (site:exploit-db.com): {query}',
                'url': f'https://www.google.com/search?q=site:exploit-db.com+{encoded_query}',
                'snippet': 'ExploitDB-specific Google search (manual browsing required)',
                'cves': [],
                'score': 20
            }
        ]

        return search_links[:max_results]

    def search_github_via_google(self, cve_id: str) -> List[Dict[str, Any]]:
        """
        Search for GitHub repositories via Google (useful when GitHub API rate limited).
        """
        query = f'site:github.com {cve_id} exploit OR poc'
        return self.search_exploits(cve_id=cve_id, keywords=['site:github.com'], max_results=10)

    def search_exploitdb_via_google(self, cve_id: str) -> List[Dict[str, Any]]:
        """
        Search for ExploitDB entries via Google.
        """
        query = f'site:exploit-db.com {cve_id}'
        return self.search_exploits(cve_id=cve_id, keywords=['site:exploit-db.com'], max_results=10)
